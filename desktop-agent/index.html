<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Lookout</title>

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    h2 { margin-bottom: 10px; }
    #status { margin: 10px 0; padding: 10px; background: #eee; border-radius: 5px; }
    .card { background: #fff; padding: 12px; border-radius: 8px; border: 1px solid #ddd; }
    label { display: block; margin-top: 10px; font-size: 13px; }
    input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; }
    button { margin-top: 12px; padding: 10px 14px; font-size: 14px; cursor: pointer; border: none; border-radius: 6px; }
    button.primary { background: #2563eb; color: #fff; }
    button.accept { background: #4CAF50; color: white; }
    button.deny { background: #f44336; color: white; margin-left: 8px; }
    .row { display: flex; gap: 10px; }
    .row > button { flex: 1; }
    .hint { margin-top: 10px; font-size: 12px; color: #555; }
  </style>
</head>

<body>
  <h2>Lookout</h2>

  <div id="status">üîå Iniciando...</div>

  <div id="setup" class="card" style="display:none;">
    <h3 style="margin:0 0 8px 0;">Configurar conex√£o</h3>
    <div style="font-size:13px; color:#444;">
      Este PC precisa do <b>Device ID</b> e <b>Token</b> para conectar.
    </div>

    <label>URL (WebSocket)</label>
    <input id="cfgUrl" placeholder="ws://localhost:3001" />

    <label>Device ID</label>
    <input id="cfgDeviceId" placeholder="ex: device1" />

    <label>Token</label>
    <input id="cfgToken" placeholder="ex: test" />

    <button class="primary" id="btnSave">Salvar e Conectar</button>
    <div id="setupMsg" style="margin-top:10px; font-size:13px;"></div>

    <div class="hint">
      Dica local: use <b>ws://localhost:3001</b>
    </div>
  </div>

  <div id="controls"></div>

  <script>
    /* ===== DEBUG (confirma build + preload) ===== */
    console.log("INDEX NOVO OK ‚úÖ", window.electronAPI?.__buildTag);
    console.log("electronAPI keys:", Object.keys(window.electronAPI || {}));

    const statusEl = document.getElementById("status");
    const controlsEl = document.getElementById("controls");

    const setupEl = document.getElementById("setup");
    const cfgUrl = document.getElementById("cfgUrl");
    const cfgDeviceId = document.getElementById("cfgDeviceId");
    const cfgToken = document.getElementById("cfgToken");
    const setupMsg = document.getElementById("setupMsg");
    const btnSave = document.getElementById("btnSave");

    function showSetup(message) {
      setupEl.style.display = "block";
      controlsEl.innerHTML = "";
      statusEl.innerText = "‚öôÔ∏è Precisa configurar para conectar.";
      setupMsg.textContent = message || "";
    }

    async function loadConfig() {
      const cfg = await window.electronAPI.getConfig();
      if (!cfg) {
        cfgUrl.value = "ws://localhost:3001";
        showSetup("Cole o Device ID e Token e clique em Salvar.");
        return;
      }

      cfgUrl.value = cfg.url || "ws://localhost:3001";
      cfgDeviceId.value = cfg.deviceId || "";
      cfgToken.value = cfg.token || "";
      setupEl.style.display = "none";
      statusEl.innerText = "üîå Aguardando conex√£o...";
    }

    window.electronAPI.onNeedConfig(() => {
      showSetup("Config n√£o encontrada. Preencha para conectar.");
    });

    btnSave.addEventListener("click", async () => {
      setupMsg.textContent = "";

      const res = await window.electronAPI.saveConfig({
        url: cfgUrl.value,
        deviceId: cfgDeviceId.value,
        token: cfgToken.value,
      });

      if (!res?.ok) {
        setupMsg.style.color = "#b91c1c";
        setupMsg.textContent = res?.error || "Erro ao salvar.";
        return;
      }

      setupMsg.style.color = "#166534";
      setupMsg.textContent = "‚úÖ Salvo! Conectando...";
      setupEl.style.display = "none";
      statusEl.innerText = "üîå Conectando...";
    });

    window.electronAPI.onWsConnected(() => {
      statusEl.innerText = "üü¢ Conectado ao servidor.";
      setupEl.style.display = "none";
    });

    window.electronAPI.onAdminConnected((admin) => {
      statusEl.innerText = `‚úÖ O administrador ${admin} est√° online.`;
    });

    // ==========================
    // CAPTURA + ENVIO DE FRAMES
    // ==========================
    let captureTimer = null;
    let activeStream = null;
    let lastAdminName = null;

    async function startScreenShare() {
      const sources = await window.electronAPI.getDesktopSources();

      const preferred =
        sources.find(s => /screen|tela|display|monitor/i.test(s.name)) ||
        sources.find(s => /entire|primary/i.test(s.name)) ||
        sources[0];

      if (!preferred?.id) throw new Error("N√£o foi poss√≠vel selecionar uma fonte de tela.");

      const stream = await navigator.mediaDevices.getUserMedia({
        audio: false,
        video: {
          mandatory: {
            chromeMediaSource: "desktop",
            chromeMediaSourceId: preferred.id,
          },
        },
      });

      return { stream, sourceName: preferred.name };
    }

    async function startSendingFrames() {
      if (captureTimer) return;

      const cfg = await window.electronAPI.getConfig();
      if (!cfg?.deviceId) throw new Error("Sem deviceId no config.");

      const { stream, sourceName } = await startScreenShare();
      activeStream = stream;

      // video OFFSCREEN (N√ÉO anexar no DOM)
      const video = document.createElement("video");
      video.srcObject = stream;
      video.muted = true;
      video.playsInline = true;
      await video.play();

      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d", { willReadFrequently: true });

      statusEl.innerText = `üì§ Enviando tela (${sourceName}) para o admin...`;

      captureTimer = setInterval(() => {
        try {
          const w = video.videoWidth || 1280;
          const h = video.videoHeight || 720;

          canvas.width = w;
          canvas.height = h;

          ctx.drawImage(video, 0, 0, w, h);

          // base64 jpeg
          const jpeg = canvas.toDataURL("image/jpeg", 0.6);

          window.electronAPI.sendScreenFrame?.({
            type: "screen_frame",
            deviceId: cfg.deviceId,
            jpeg,
            ts: Date.now(),
          });
        } catch (e) {
          console.error("frame error:", e);
        }
      }, 200); // ~5fps
    }

    function stopSendingFrames() {
      if (captureTimer) {
        clearInterval(captureTimer);
        captureTimer = null;
      }
      if (activeStream) {
        activeStream.getTracks().forEach(t => t.stop());
        activeStream = null;
      }
    }

    // ==========================
    // CONSENT UI
    // ==========================
    window.electronAPI.onConsentRequest((admin) => {
      lastAdminName = admin || null;
      statusEl.innerText = `‚ö†Ô∏è O administrador ${admin} solicitou acesso √† sua tela.`;
      controlsEl.innerHTML = `
        <div class="row">
          <button class="accept" id="accept">Aceitar</button>
          <button class="deny" id="deny">Negar</button>
        </div>
        <div class="hint">
          Ao aceitar, este app N√ÉO mostra a tela. Ele apenas envia para o Admin Console.
        </div>
      `;

      document.getElementById("accept").onclick = async () => {
        window.electronAPI.sendConsentResponse(true);

        controlsEl.innerHTML = "";
        statusEl.innerText = `‚úÖ Permiss√£o concedida${lastAdminName ? " para " + lastAdminName : ""}. Iniciando envio...`;

        try {
          await startSendingFrames();
        } catch (e) {
          console.error(e);
          statusEl.innerText = "‚ùå Falha ao iniciar envio da tela.";
        }
      };

      document.getElementById("deny").onclick = () => {
        window.electronAPI.sendConsentResponse(false);
        stopSendingFrames();
        controlsEl.innerHTML = "";
        statusEl.innerText = "‚õî Acesso negado.";
      };
    });

    loadConfig();
  </script>
</body>
</html>
